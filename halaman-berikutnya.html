<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Review dan Kirim Fotomu - BGT</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header -->
  <div class="flex items-center p-4 border-b bg-white">
    <button onclick="history.back()" class="text-xl mr-3">‚Üê</button>
    <h1 class="text-lg font-semibold">Review dan Kirim Fotomu</h1>
  </div>

  <!-- Info -->
  <div class="p-4 bg-blue-50 text-gray-700 flex items-start space-x-2">
    <div class="text-blue-500 text-xl">‚Ñπ</div>
    <p>Pastikan foto kamu sudah terlihat jelas biar bisa kami proses secepatnya.</p>
  </div>

  <!-- Form Upload -->
  <div class="flex-1 overflow-y-auto p-4 space-y-6">
    <!-- Foto KTP -->
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <h2 class="font-semibold text-lg mb-2">Foto e-KTP</h2>
      <p class="text-green-600 text-sm mb-2">Lihat tutorial</p>
      <div class="flex items-center justify-between">
        <div id="previewKTP" class="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-400 text-3xl">üì∑</div>
        <div>
          <button onclick="openCamera('previewKTP')" class="border border-green-600 text-green-600 px-4 py-2 rounded-full">Ambil foto</button>
          <input type="file" id="fotoKTP" accept="image/*" class="hidden" onchange="previewImage(event, 'previewKTP')">
          <button onclick="document.getElementById('fotoKTP').click()" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-full mt-2">Pilih dari Galeri</button>
        </div>
      </div>
    </div>

    <!-- Selfie -->
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <h2 class="font-semibold text-lg mb-2">Selfie</h2>
      <div class="flex items-center justify-between">
        <div id="previewSelfie" class="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-400 text-3xl">üì∑</div>
        <div>
          <button onclick="openCamera('previewSelfie')" class="border border-green-600 text-green-600 px-4 py-2 rounded-full">Ambil foto</button>
          <input type="file" id="fotoSelfie" accept="image/*" class="hidden" onchange="previewImage(event, 'previewSelfie')">
          <button onclick="document.getElementById('fotoSelfie').click()" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-full mt-2">Pilih dari Galeri</button>
        </div>
      </div>
    </div>

    <div class="text-sm text-gray-600 border rounded-xl p-3 bg-white">
      Informasimu dirahasiakan dan hanya digunakan untuk verifikasi.  
      <p class="text-green-600 font-semibold mt-1">B-Car menjamin kerahasiaan data</p>
    </div>
  </div>

  <!-- Tombol Kirim -->
  <div class="p-4 bg-white border-t">
    <button id="btnKirim" onclick="uploadData()" class="w-full bg-gray-300 text-white py-3 rounded-full font-semibold" disabled>Kirim</button>
  </div>

  <!-- Popup Kamera -->
  <div id="cameraPopup" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50">
    <video id="video" autoplay playsinline class="rounded-xl w-11/12 max-w-md"></video>
    <button onclick="takePhoto()" class="mt-4 bg-green-600 text-white px-5 py-2 rounded-full">üì∏ Ambil Foto</button>
    <button onclick="closeCamera()" class="mt-2 text-gray-300 underline">Tutup</button>
  </div>

<script>
  // --- Konfigurasi Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyD3FQbFF5a91MlASpqImTMmGkYvaTcdxm0",
    authDomain: "kadek-ed34e.firebaseapp.com",
    databaseURL: "https://kadek-ed34e-default-rtdb.firebaseio.com",
    projectId: "kadek-ed34e",
    storageBucket: "kadek-ed34e.firebasestorage.app",
    messagingSenderId: "65756136303",
    appId: "1:65756136303:web:6dbe5bc658fadb05ca1e9a",
    measurementId: "G-5WSR57JC7V"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  let ktpFile = null;
  let selfieFile = null;
  let currentTarget = null;
  let currentStream = null;

  // --- Fungsi Kamera Baru ---
  async function openCamera(targetId) {
    currentTarget = targetId;
    const popup = document.getElementById('cameraPopup');
    popup.classList.remove('hidden');
    const video = document.getElementById('video');

    try {
      currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = currentStream;
    } catch (err) {
      alert("Tidak dapat mengakses kamera. Pastikan izin sudah diberikan.");
      console.error(err);
      popup.classList.add('hidden');
    }
  }

  function takePhoto() {
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg');

    // tampilkan preview
    document.getElementById(currentTarget).innerHTML = `<img src="${dataUrl}" class="w-24 h-24 object-cover rounded-lg"/>`;

    if (currentTarget === 'previewKTP') ktpFile = dataUrl;
    if (currentTarget === 'previewSelfie') selfieFile = dataUrl;

    // aktifkan tombol kirim jika dua foto sudah ada
    if (ktpFile && selfieFile) {
      const btn = document.getElementById("btnKirim");
      btn.disabled = false;
      btn.classList.replace("bg-gray-300", "bg-green-600");
    }

    closeCamera();
  }

  function closeCamera() {
    const popup = document.getElementById('cameraPopup');
    popup.classList.add('hidden');
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
  }

  // --- Preview dari Galeri ---
  function previewImage(event, previewId) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function() {
      document.getElementById(previewId).innerHTML = `<img src="${reader.result}" class="w-24 h-24 object-cover rounded-lg"/>`;
      if (previewId === "previewKTP") ktpFile = reader.result;
      if (previewId === "previewSelfie") selfieFile = reader.result;

      if (ktpFile && selfieFile) {
        const btn = document.getElementById("btnKirim");
        btn.disabled = false;
        btn.classList.replace("bg-gray-300", "bg-green-600");
      }
    };
    reader.readAsDataURL(file);
  }

  // --- Upload ke Firebase ---
  async function uploadData() {
    if (!ktpFile || !selfieFile) return alert("Silakan upload semua foto dulu.");

    const btn = document.getElementById("btnKirim");
    btn.innerText = "Mengirim...";
    btn.disabled = true;
    btn.classList.replace("bg-green-600", "bg-gray-400");

    const timestamp = Date.now();
    const ktpRef = storage.ref('verifikasi/' + timestamp + '_ktp.jpg');
    const selfieRef = storage.ref('verifikasi/' + timestamp + '_selfie.jpg');

    try {
      await ktpRef.putString(ktpFile, 'data_url');
      await selfieRef.putString(selfieFile, 'data_url');

      const ktpURL = await ktpRef.getDownloadURL();
      const selfieURL = await selfieRef.getDownloadURL();

      await db.ref('verifikasi/' + timestamp).set({
        fotoKTP: ktpURL,
        fotoSelfie: selfieURL,
        status: 'menunggu',
        waktuUpload: new Date().toLocaleString()
      });

      btn.innerText = "Terkirim ‚úÖ";
      alert("Foto berhasil dikirim. Kami akan segera memverifikasi datamu.");
    } catch (error) {
      console.error(error);
      btn.innerText = "Gagal kirim. Coba lagi.";
      btn.classList.replace("bg-gray-400", "bg-red-600");
      alert("Gagal mengirim foto. Silakan coba lagi.");
    }
  }
</script>
</body>
</html>
